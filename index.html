<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>TTRPG XML → Character Sheet (Clean Build)</title>
<style>
  :root{ --bg:#0b0d10; --panel:#111417; --ink:#e9eef6; --muted:#a7b0bd; --line:#1f2630; --accent:#3ea6ff; --accent-2:#7bd389; }
  *{box-sizing:border-box}
  html{ -webkit-text-size-adjust: 100%; }
  body{margin:0;background:var(--bg);color:var(--ink);font:400 15px/1.35 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial}
  .wrap{max-width:1100px;margin:0 auto;padding:18px}
  header{position:sticky;top:0;z-index:100;background:linear-gradient(180deg, rgba(11,13,16,.9), rgba(11,13,16,.75));backdrop-filter:saturate(1.2) blur(6px);border-bottom:1px solid var(--line);}
  header .bar{display:flex;gap:10px;align-items:center;justify-content:space-between;padding:12px 0}
  .title{font:800 18px/1 ui-sans-serif, system-ui;letter-spacing:.2px}
  .actions{display:flex;gap:8px;flex-wrap:wrap}
  button,.file-label{border:1px solid var(--line);background:#0e1216;color:var(--ink);padding:10px 14px;border-radius:12px;cursor:pointer;box-shadow:0 1px 0 rgba(0,0,0,.2);font-weight:700;font-size:14px}
  button:hover,.file-label:hover{border-color:#2a313c}
  input[type=file]{display:none}
  .drop{border:2px dashed var(--line);border-radius:14px;padding:14px;background:#0e1216;color:var(--muted);text-align:center}
  .status{margin:10px 0 0;font-size:13px;color:var(--accent-2);display:none}
  .status.error{color:#ff8585}
  .sheet{display:grid;gap:12px;margin-top:12px}
  .box{border:1px solid var(--line);border-radius:14px;padding:14px;background:var(--panel);display:flex;flex-direction:column;gap:10px;min-height:auto}
  .box h3{margin:0;font:700 12px/1.2 ui-sans-serif;color:var(--muted);text-transform:uppercase;letter-spacing:.08em}
  .grid{display:grid;gap:10px}
  .kv{display:grid;gap:10px;grid-template-columns:1fr 1fr}
  .kv .v{font-weight:800;word-break:break-word}
  .stats{display:grid;gap:10px;grid-template-columns:repeat(6,1fr)}
  .stat{border:1px solid var(--line);border-radius:12px;padding:10px;text-align:center}
  .stat .lab{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.06em}
  .stat .big{font-size:22px;font-weight:900;line-height:1.1}
  .rows .hdr{display:grid;grid-template-columns:2fr 1fr 1fr 1fr;gap:10px;font:700 12px/1 ui-sans-serif;color:var(--muted);text-transform:uppercase}
  .row{display:grid;grid-template-columns:2fr 1fr 1fr 1fr;gap:10px;border:1px solid var(--line);border-radius:12px;padding:10px}
  .cell{overflow-wrap:anywhere}
  .badge{display:inline-block;font:800 10px/1 ui-sans-serif;border:1px solid var(--line);border-radius:999px;padding:2px 6px;color:var(--muted)}
  .list>.item{padding:6px 0;border-bottom:1px solid var(--line)}
  .list>.item:last-child{border-bottom:0}
  .muted{color:var(--muted)}
  .credits{display:flex;justify-content:space-between;color:var(--muted);font-size:12px;margin:6px 0 0}
  @media (max-width:900px){.kv{grid-template-columns:1fr}.stats{grid-template-columns:repeat(3,1fr)}}
  @media (max-width:700px){.sheet{grid-template-columns:1fr}.rows .hdr{display:none}.row{grid-template-columns:1fr}.row .cell{display:flex;justify-content:space-between;gap:10px}.row .cell::before{content:attr(data-lab);color:var(--muted);font:700 11px/1 ui-sans-serif;text-transform:uppercase;letter-spacing:.05em;padding-right:10px}}
  @media print{body{background:#fff;color:#000}header,.drop{display:none !important}.box{break-inside:avoid}}
</style>
</head>
<body>
  <header>
    <div class="wrap bar">
      <div class="title">TTRPG Character Sheet (XML ⇢ Sheet)</div>
      <div class="actions">
        <label class="file-label"><input id="file" type="file" accept=".xml, text/xml, application/xml, */*">Load XML</label>
        <button id="pasteBtn">Paste XML</button>
        <button id="printBtn">Print / PDF</button>
        <button id="exportBtn">Export JSON</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="drop" id="drop">Drop your <b>.xml</b> here, or use <b>Load XML</b>. On iPhone, open this page in <b>Safari</b>, not Files preview.</div>
    <div id="status" class="status" role="status" aria-live="polite"></div>
    <section id="sheet" class="sheet"></section>
    <div class="credits"><div>Self‑contained: no external libs</div><div>Share this file; anyone can load their XML</div></div>
  </main>

  <dialog id="dlg">
    <form method="dialog" style="max-width:900px;width:min(96vw,900px)">
      <h3 style="margin:.2rem 0 .6rem;font:700 14px ui-sans-serif;color:#222">Paste raw XML</h3>
      <textarea id="pasteArea" rows="14" style="width:100%;padding:10px;border:1px solid #ccc;border-radius:10px;font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace"></textarea>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
        <button value="cancel">Cancel</button>
        <button id="importBtn" value="default">Import</button>
      </div>
    </form>
  </dialog>

<script>
(() => {
  const $ = (s, el=document) => el.querySelector(s);
  const byId = id => document.getElementById(id);
  const elSheet = byId("sheet");
  const elStatus = byId("status");

  function setStatus(msg, isErr=false){
    elStatus.textContent = msg || "";
    elStatus.className = "status" + (isErr ? " error" : "");
    elStatus.style.display = msg ? "block" : "none";
  }

  async function readFileText(file){
    if(!file) throw new Error("No file selected");
    if(typeof file.text === "function"){
      try { const t = await file.text(); if(t) return t; } catch {}
    }
    return new Promise((res, rej) => {
      const fr = new FileReader();
      fr.onload = () => res(String(fr.result || ""));
      fr.onerror = () => rej(fr.error || new Error("Failed to read file"));
      try { fr.readAsText(file, "utf-8"); } catch { fr.readAsText(file); }
    });
  }

  function cleanText(t){ return String(t||"").replace(/^\\ufeff/, "").replace(/\\0/g,""); }
  function parseXML(text){
    const xml = new DOMParser().parseFromString(cleanText(text), "text/xml");
    const err = xml.getElementsByTagName("parsererror")[0];
    if(err) throw new Error(err.textContent || "Invalid XML");
    return xml;
  }
  function pick(root, selectors, def=""){
    for(const s of selectors){
      const n = root.querySelector(s);
      if(!n) continue;
      const v = (n.textContent ?? n.getAttribute?.("value") ?? "").trim();
      if(v) return v;
    }
    return def;
  }
  function listChildren(root, selList){
    for(const s of selList){
      const r = root.querySelector(s);
      if(!r) continue;
      const out = [];
      r.childNodes.forEach(n => { if(n.nodeType === 1) out.push(n); });
      if(out.length) return out;
    }
    return [];
  }
  function esc(s){ return String(s ?? "").replace(/[&<>\"']/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[c])); }
  function joinNonEmpty(arr, sep=" "){ return (arr||[]).filter(Boolean).join(sep); }
  const num = (v, d=0) => { const n = parseFloat(String(v||"").replace(/[^0-9.\\-]/g,"")); return isFinite(n) ? n : d; };
  const normalizeDice = d => { if(!d) return ""; const s = String(d).trim(); if(/^\\d+d\\d+$/i.test(s)) return s.toLowerCase(); if(/^d\\d+$/i.test(s)) return ("1" + s.toLowerCase()); return s.toLowerCase(); };
  const txt = n => n ? n.textContent.replace(/\\s+/g," ").trim() : "";

  function extract(xml){
    const data = {};
    data.name = pick(xml, ["character>name","name"]);
    data.player = pick(xml, ["playername","player","owner","who"]);
    data.class = pick(xml, ["classes>id-00001>name","class","details>class"]);
    data.level = pick(xml, ["classes>id-00001>level","level"]);
    data.race = pick(xml, ["race"]);
    data.theme = pick(xml, ["theme"]);
    data.alignment = pick(xml, ["alignment","character>details>alignment"]);
    data.gender = pick(xml, ["gender"]);
    data.size = pick(xml, ["size"]);
    data.speed = pick(xml, ["speed>total","speed>final","speed","movement>speed"]);
    data.init = pick(xml, ["initiative>total","initiative"]);

    const abil = {};
    ["strength","dexterity","constitution","intelligence","wisdom","charisma"].forEach(key => {
      const node = xml.querySelector(`abilities>${key}`) || xml.querySelector(key);
      const score = node ? pick(node, ["score"]) : "";
      let mod = node ? pick(node, ["bonusmodifier","bonus","mod","modifier"]) : "";
      if(!mod && score && isFinite(+score)) mod = String(Math.floor((+score - 10)/2));
      const tag = key.slice(0,3).toUpperCase();
      abil[tag] = {score, mod};
    });
    data.abilities = abil;

    data.hp = { current: pick(xml, ["hp>current","health>hp>current"]), max: pick(xml, ["hp>total","hp>max","health>hp>total"]) };
    data.sp = { current: pick(xml, ["sp>current","stamina>current"]), max: pick(xml, ["sp>total","sp>max","stamina>max"]) };
    data.rp = { current: pick(xml, ["rp>current","resolve>current"]), total: pick(xml, ["rp>total","resolve>total","rp"]) };

    data.ac = { eac: pick(xml, ["ac>totals>eac","ac>eac>total","eac>total","ac>eac"]), kac: pick(xml, ["ac>totals>kac","ac>kac>total","kac>total","ac>kac"]) };
    data.saves = { fort: pick(xml, ["saves>fortitude>total","fortitude>total","fortitude"]), ref: pick(xml, ["saves>reflex>total","reflex>total","reflex"]), will: pick(xml, ["saves>will>total","will>total","will"]) };

    data.skills = listChildren(xml, ["skilllist","skills"]).map(n => ({
      name: pick(n, ["label","name"]),
      total: pick(n, ["total","mod","value"]),
      ranks: pick(n, ["ranks","rank"]),
      ability: pick(n, ["statname","ability","stat"]),
      classSkill: pick(n, ["state","classskill","class"])
    })).filter(s => s.name);

    const pSkill = data.skills.find(s => (s.name||"").toLowerCase() === "perception");
    data.perception = pick(xml, ["skills>perception>total","perception>total","perception"]) || (pSkill ? pSkill.total : "");

    const modMap = { strength: num(abil.STR?.mod), dexterity: num(abil.DEX?.mod), constitution: num(abil.CON?.mod), intelligence: num(abil.INT?.mod), wisdom: num(abil.WIS?.mod), charisma: num(abil.CHA?.mod) };
    data.attacks = listChildren(xml, ["weaponlist","weapons","attacks","attacklist"]).map(w => {
      const name = pick(w, ["name","label","weaponname"]);
      const attack0 = pick(w, ["attack0","attackbonus>total","attack","tohit"]);
      const properties = pick(w, ["properties"]);
      const range = pick(w, ["rangeincrement","range"]);
      let dmg = "";
      const dnode = w.querySelector("damagelist") || w.querySelector("damage");
      if(dnode){
        const first = (Array.from(dnode.children).find(c => c.nodeType===1)) || dnode;
        const dice = normalizeDice(pick(first, ["dice"]));
        const bonus = num(pick(first, ["bonus"]), 0);
        const stat = pick(first, ["stat"]).toLowerCase();
        const mult = num(pick(first, ["statmult"]), 0);
        const type = pick(first, ["type"]);
        const crit = pick(first, ["criteffect"]);
        const statBonus = (stat && modMap[stat] ? mult * modMap[stat] : 0);
        const totalBonus = bonus + statBonus;
        const bonusStr = totalBonus ? (totalBonus > 0 ? ` +${totalBonus}` : ` ${totalBonus}`) : "";
        const typeStr = type ? ` ${type.split(";")[0].trim()}` : "";
        const critStr = crit || (type && type.includes(";") ? ` (${type.split(";").slice(1).join(";").trim()})` : "");
        dmg = `${dice}${bonusStr}${typeStr}${critStr ? ` ${critStr.startsWith("(")?critStr:`(${critStr})`}`:""}`.trim();
      }
      const atk = attack0 ? (/^[+-]?\d+$/.test(String(attack0)) ? ((+attack0>=0?"+":"")+attack0) : attack0) : "";
      const extra = [properties, range ? `${range} ft` : ""].filter(Boolean).join(" • ");
      return {name, atk, dmg, type: extra};
    }).filter(a => a.name);

    function featsFrom(listName, kind){
      const root = xml.querySelector(listName);
      if(!root) return [];
      const out = [];
      root.childNodes.forEach(n => {
        if(n.nodeType !== 1) return;
        const name = pick(n, ["name","label"]);
        if(!name) return;
        const parts = [];
        ["summary","benefit","special","normal","text","description"].forEach(k => {
          const v = txt(n.querySelector(k));
          if(!v) return;
          if(k==="special") parts.push("Special: " + v);
          else if(k==="normal") parts.push("Normal: " + v);
          else parts.push(v);
        });
        out.push({name, notes: parts.join(" "), kind});
      });
      return out;
    }
    data.feats = [...featsFrom("featlist","Feat"), ...featsFrom("proficiencylist","Proficiency"), ...featsFrom("specialabilitylist","Feature")];

    data.inventory = listChildren(xml, ["inventorylist","inventory","items","itemlist"]).map(n => ({
      name: pick(n, ["name","label"]),
      qty: pick(n, ["count","quantity","qty","amount"]) || "1",
      bulk: pick(n, ["bulk"]),
      cost: pick(n, ["cost","price","value","credits"]),
      notes: txt(n.querySelector("description")) || pick(n, ["text","notes"])
    })).filter(i => i.name);
    let credits = pick(xml, ["credits>total","credits"]);
    if(!credits){
      const coins = listChildren(xml, ["coins"]);
      const cnode = coins.find(n => /credits/i.test(pick(n,["name"])));
      if(cnode) credits = pick(cnode, ["amount"]);
    }
    data.credits = credits;

    data.notes = pick(xml, ["notes","bio","background>text","description"]);
    return data;
  }

  const E = (tag, cls, html) => { const e = document.createElement(tag); if(cls) e.className = cls; if(html!=null) e.innerHTML = html; return e; };
  const stat = (lab,val) => E("div","stat", `<div class="lab">${esc(lab)}</div><div class="big">${esc(val||"")}</div>`);

  function render(data){
    window.__lastData = data;
    elSheet.innerHTML = "";

    const char = E("div","box",""); char.appendChild(E("h3","","Character"));
    const kv = E("div","kv","");
    kv.appendChild(E("div","",`<div class="muted">Name</div><div class="v">${esc(data.name||"")}</div>`));
    kv.appendChild(E("div","",`<div class="muted">Player</div><div class="v">${esc(data.player||"")}</div>`));
    kv.appendChild(E("div","",`<div class="muted">Class</div><div class="v">${esc(joinNonEmpty([data.class, data.level && ("Lvl "+data.level)]))}</div>`));
    kv.appendChild(E("div","",`<div class="muted">Race / Theme</div><div class="v">${esc(joinNonEmpty([data.race, data.theme], " • "))}</div>`));
    kv.appendChild(E("div","",`<div class="muted">Alignment</div><div class="v">${esc(data.alignment||"")}</div>`));
    kv.appendChild(E("div","",`<div class="muted">Gender / Size</div><div class="v">${esc(joinNonEmpty([data.gender, data.size], " • "))}</div>`));
    char.appendChild(kv); elSheet.appendChild(char);

    const abilities = E("div","box",""); abilities.appendChild(E("h3","","Abilities"));
    const stats = E("div","stats","");
    for(const [k,v] of Object.entries(data.abilities||{})){ stats.appendChild(stat(k, v?.score||"")); }
    abilities.appendChild(stats); elSheet.appendChild(abilities);

    const vit = E("div","box",""); vit.appendChild(E("h3","","Vitality & Defenses"));
    const vg = E("div","grid",""); vg.style.gridTemplateColumns = "repeat(5,1fr)";
    vg.appendChild(stat("HP", `${data.hp?.current||""}/${data.hp?.max||""}`));
    vg.appendChild(stat("SP", `${data.sp?.current||""}/${data.sp?.max||""}`));
    vg.appendChild(stat("RP", `${data.rp?.current||""}/${data.rp?.total||""}`));
    vg.appendChild(stat("EAC", data.ac?.eac||""));
    vg.appendChild(stat("KAC", data.ac?.kac||""));
    vg.appendChild(stat("Init", data.init||""));
    vg.appendChild(stat("Perception", data.perception||""));
    vg.appendChild(stat("Speed", data.speed||""));
    vit.appendChild(vg); elSheet.appendChild(vit);

    const atk = E("div","box",""); atk.appendChild(E("h3","","Attacks & Weapons"));
    const ah = E("div","rows hdr", `<div>Weapon</div><div>Attack</div><div>+Damage</div><div>Props/Range</div>`); atk.appendChild(ah);
    (data.attacks||[]).forEach(w => {
      const r = E("div","row","");
      let c = E("div","cell", esc(w.name||"")); c.setAttribute("data-lab","Weapon"); r.appendChild(c);
      c = E("div","cell", esc(w.atk||"")); c.setAttribute("data-lab","Attack"); r.appendChild(c);
      c = E("div","cell", esc(w.dmg||"")); c.setAttribute("data-lab","+Damage"); r.appendChild(c);
      c = E("div","cell", esc(w.type||"")); c.setAttribute("data-lab","Props/Range"); r.appendChild(c);
      atk.appendChild(r);
    }); elSheet.appendChild(atk);

    const skl = E("div","box",""); skl.appendChild(E("h3","","Skills"));
    const sh = E("div","rows hdr", `<div>Skill</div><div>Total</div><div>Ranks</div><div>Ability</div>`); skl.appendChild(sh);
    (data.skills||[]).forEach(s => {
      const r = E("div","row","");
      const nm = (s.name||"") + (String(s.classSkill||"").match(/(yes|true|class|1)/i) ? " (Class)" : "");
      let c = E("div","cell", esc(nm)); c.setAttribute("data-lab","Skill"); r.appendChild(c);
      c = E("div","cell", esc(s.total||"")); c.setAttribute("data-lab","Total"); r.appendChild(c);
      c = E("div","cell", esc(s.ranks||"")); c.setAttribute("data-lab","Ranks"); r.appendChild(c);
      c = E("div","cell", esc(s.ability||"")); c.setAttribute("data-lab","Ability"); r.appendChild(c);
      skl.appendChild(r);
    }); elSheet.appendChild(skl);

    const feats = E("div","box",""); feats.appendChild(E("h3","","Feats & Features"));
    const list = E("div","list","");
    (data.feats||[]).forEach(f => {
      const it = E("div","item","");
      it.innerHTML = `<div><b>${esc(f.name||"")}</b>${f.kind?` <span class="badge">${esc(f.kind)}</span>`:""}</div>` + (f.notes?`<div class="muted" style="margin-top:4px">${esc(f.notes)}</div>`:"");
      list.appendChild(it);
    }); feats.appendChild(list); elSheet.appendChild(feats);

    const inv = E("div","box",""); inv.appendChild(E("h3","","Inventory " + (data.credits?`<span class='muted'>• Credits: ${esc(data.credits)}</span>`:"")));
    const ih = E("div","rows hdr", `<div>Item</div><div>Qty</div><div>Bulk</div><div>Cost</div>`); inv.appendChild(ih);
    (data.inventory||[]).forEach(i => {
      const r = E("div","row","");
      let c = E("div","cell", esc(i.name||"")); c.setAttribute("data-lab","Item"); r.appendChild(c);
      c = E("div","cell", esc(i.qty||"")); c.setAttribute("data-lab","Qty"); r.appendChild(c);
      c = E("div","cell", esc(i.bulk||"")); c.setAttribute("data-lab","Bulk"); r.appendChild(c);
      c = E("div","cell", esc(i.cost||"")); c.setAttribute("data-lab","Cost"); r.appendChild(c);
      inv.appendChild(r);
      if(i.notes){ const n = E("div","row",""); const cc = E("div","cell", `<span class="muted">${esc(i.notes)}</span>`); cc.setAttribute("data-lab","Notes"); n.appendChild(cc); inv.appendChild(n); }
    }); elSheet.appendChild(inv);

    if(data.notes){ const notes = E("div","box",""); notes.appendChild(E("h3","","Notes")); notes.appendChild(E("div","muted", esc(data.notes))); elSheet.appendChild(notes); }
  }

  async function handleText(text){
    setStatus("Parsing XML…");
    const xml = parseXML(text);
    const data = extract(xml);
    render(data);
    setStatus("Loaded.");
  }
  async function handleFile(file){
    try{
      setStatus(`Loading: ${file?.name||"file"} (${file?.size||0} bytes)…`);
      await new Promise(r=>setTimeout(r,0));
      const text = await readFileText(file);
      await handleText(text);
      const input = byId("file"); if(input) input.value = "";
    }catch(e){
      console.error(e);
      setStatus("Error: " + (e.message || String(e)), true);
      alert("Failed to load XML: " + (e.message || e));
    }
  }

  const drop = byId("drop");
  ["dragenter","dragover"].forEach(ev => drop.addEventListener(ev, e=>{e.preventDefault(); drop.style.borderColor="#2a313c"}));
  ["dragleave","drop"].forEach(ev => drop.addEventListener(ev, e=>{e.preventDefault(); drop.style.borderColor="var(--line)"}));
  drop.addEventListener("drop", e=>{ e.preventDefault(); const f = e.dataTransfer?.files?.[0]; if(f) handleFile(f); });

  byId("file").addEventListener("change", e=>{ const f = e.target.files?.[0]; if(f) handleFile(f); });

  const dlg = byId("dlg"), pasteBtn = byId("pasteBtn"), importBtn = byId("importBtn"), pasteArea = byId("pasteArea");
  pasteBtn.addEventListener("click", ()=>{ try{ dlg.showModal(); }catch{ dlg.setAttribute("open","open"); } });
  importBtn.addEventListener("click", e=>{ e.preventDefault(); const t = String(pasteArea.value||"").trim(); if(!t){ alert("Paste your XML first."); return; } handleText(t).then(()=>{ dlg.close(); pasteArea.value=""; }); });

  byId("printBtn").addEventListener("click", ()=>window.print());
  byId("exportBtn").addEventListener("click", ()=>{
    const data = window.__lastData || {};
    const blob = new Blob([JSON.stringify(data, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = (data.name ? String(data.name).replace(/[^ \w.-]+/g,"_") : "character") + ".json";
    document.body.appendChild(a); a.click();
    setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 50);
  });

  render({abilities:{STR:{},DEX:{},CON:{},INT:{},WIS:{},CHA:{}}, hp:{}, sp:{}, rp:{}, ac:{}, saves:{}});
})();
</script>
</body>
</html>